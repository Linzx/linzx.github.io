---
layout: post
title:  "Android进程设计思想(保活篇)"
date:   2016-08-13 22:30:00
catalog:  true
tags:
    - android
    - process
---

## 一、概述

进程保活是app开发者都非常关心的话题，很看过不少人分享过的相关文章，这些文章中提到的策略基本都是相互借鉴，缺乏实战分析，容易误导app开发者。导致Android圈更加混乱，很多策略是然并卵的，除了让手机功耗提升，性能拉低，并无他处。

关于进程保活，这个话题该以怎样一个形式跟大家来分享，思前想后，觉得还是跟大家聊聊Android进程的设计思想吧。

我之前所写博客的受众更多的是系统工程师或者是对底层感兴趣的app开发工程师，更多的是直接把源码拿来分析，因为个人比较欣赏RTFSC(Reading The Fucking Source Code)的态度，代码是非常具有说服力。为了让更多的app开发者理解进程保活，本文打算采用新的文笔，尽可能少贴源码。 我先来列举几个大家可能会关心的问题：

1. 目前的各种进程保活策略，是如何失效的？
2. 为什么微信这类app能成功保活？
3. 为什么有些保活策略有时候能保活成功，有时候不能保活成功？
4. app采用多进程架构，能否提升保活率？
5. 厂商是如何应对进程保活的？
6. 关于个推，该如何选择？
7. 作为app开发对于进程保活，到底能做什么优化？

如果上述所有问题，都没有你感兴趣的话题，那么建议你不用再往下看。 接下来，进入正文。

## 二、 进程保活

要回答前面的一系列问题，其实只需要掌握两个核心问题就明白了一切：

- 什么场景下进程会被杀？
- 杀进程是采取什么策略？




### 进程

相信大家都有这样的体会，那就是App首次打开的时候速度会比较慢，之后再次打开速度会快些，这就是冷启动和热启动的差距。

- 热启动是指App的进程已启动，只需要直接进入Activiy等组件的生命周期即可；
- 冷启动是指App的进程尚未启动，需要先创建进程，再执行具体的生命周期。

简单来说冷启动比热启动多了进程创建的过程，该过程比较曲折，有兴趣的可以查看我的另一个文章[理解Android进程创建流程](http://gityuan.com/2016/03/26/app-process-create/)

### Android设计思想

Android系统总是尽可能长时间地保持app进程，即使是后台进程或者空进程，也不会立即杀掉，这样的设计可以下一次再次使用这些app时无需重新启动进程，提高响应速度。

#### lmk

系统总内存是有限的，无法同时承载所有的app进程，随着系统地使用运行时长，系统的可用内存可能慢慢地会变得不足，为了防止出现内存不足导致系统异常的出现，这时系统需要有一个方案来决策该杀哪些进程，不该杀哪些进程。这便引出了LowMemoryKiller(简称lmk)，根据不同地剩余可用内存级别来决定杀掉不同的adj级别的进程。

#### ams

当内存还很宽裕（即没有触发lmk）的情况下，是不是意味着不会有进程被杀呢？答案是否定的，在framework层ams也具有进程的生杀大权。当系统空进程或者缓存进程超过系统设置的个数上限，再或者空进程后台空闲时间超过系统设定时长，则由AMS负责杀掉该进程。

我佛慈悲，为何内存宽裕了，ams还要生杀呢？因为对于系统来说每一个进程的维护都是有成本的，所有的进程都保存在LRU进程队列，每个进程还有自身的ProcessRecord对象，以及系统各处都有会记录该进程的通关文牒。每一次更新状态，比如updateOomAdjLocked或者updateLruProcessLocked等操作，都需要遍历系统所有的进程，而且这些操作频率比较高。那么对于长时间未使用的进程，ams认为再次被使用的可能性也相对更低，则会杀掉该进程。

那具体满足什么时候的进程，会被ams杀掉呢？对于这个问题很难回答，原因是不同厂商会有不同的内存优化策略，甚至友商曾在某些机型采用极度激进策略，后台不允许缓存进程，放后台则杀无赦。这里简单说说google原生设计的数据，好让大家有个大概的数。

- 空进程个数超过16个，则开始杀进程；
- 空进程超过8个，且空进程后台时间超过30min，则开始杀进程；
- 缓存进程个数超过32个，则开始杀进程；

#### crash

影响app保活的，除了系统的lmk和ams机制，更重要的是"打铁还需自身硬"，保证app的稳定性，这才是app保活最需要干的活。

- 当app发生crash时，无论是Java层的crash，还是Native Crash，系统都将强制杀掉出问题的进程；
- 当app出现ANR时，如果是后台并且不会影响用户的app，则也会直接杀掉；否则，会弹出ForceClose的对话框，让用户来选择结束其生命；

与其花心思用在如何采取流氓地保活策略，还不如一起来改善Android的用户体验，每个app开发人员争取尽可能地降低Crash和ANR发生的概率，那么自然在同类竞争产品，你的app将脱颖而出，并且也算是为Android界赢得一份口碑，不至于让用户提到Android，就觉得系统不够稳定或者比较卡顿。虽然对于手机稳定性、流畅性的课题，各大厂商都在积极努力地改善，但很多时候app引发系统卡顿，以及app的crash，用户往往都会归罪于Android手机的优劣。所以，在此呼吁广大的app开发人员多在稳定性与性能方向花功夫，让Android有一个更好的前程，需要你我他共同的护航。

#### force-stop

#### 杀进程策略

#### 保活策略

forceStopPackageLock/ killBackgroupProcesses都是以pkg的粒度来杀进程
AMS.killPackageProcessesLocked，解决多进程架构；

Process.killProcessGroup，解决Native fork进程的策略；


#### 大家都存活的后果
1.进程刚切换到后台，虽然优先级很高，也马上会被杀，再次启动则采用冷启动的方式


### 策略

1. 系统可用内存较低的情况下，则触发lmk根据具体的可用内存大小来决定杀掉不同的adj级别的进程；
2.
3. 用户手动杀进程；

### 2.1 进程




1. 当前进程保护的不可取
2. force-stop的功能
3. adj算法

1. 进程不死；
2. 进程死后马上拉起

### 设计之坑

高手过招，往往一招定胜负，前面介绍了不少关于进程的设计思想，都是为了Android保驾护航为精心设计的。如果这篇文章就此而结束，干货未免还有些不足，接下来，我就倾囊相授，跟大家聊一聊Google设计之坑。Android系统本身有很多坑，而厂商更多的工作是跟Google一起填坑，本文的讨论的话题是进程保活，继续围绕着这个话题，我来跟大家分享两个Goolge之坑，为你的保活之路更稳健。

#### classloader

相信很多app开发者，或多或少都使用到了反射机制，尤其是在这个插件化/热修复盛行的时期，各种框架应运而生，dexposed、andfix，Nuwa、Tinker等各种框架，本文的重点不是介绍插件化，这里也就不展开说了，下面就来说说反射对于进程保活会带来什么样的坑。

前段时间，在一次群发邮件里，看到UC浏览器的朋友发现豌豆荚被杀会导致UC浏览器也同时被杀，以为是厂商定制化导致，向小米求助。当我第一眼看到这个问题，感觉这个问题应该是google或者UC自身的问题，为了验证这个猜想，立刻拿来三星、联想以及原生Rom等手机来测试了一把，果不其然都发生了级联被杀的事件。其实到这里，完全可以回复UC的人让他们自己去查，这已然确定不是某家厂商的问题。谁让我心好，谁让我好奇呢，根据他们提供的复现方式，深入调研。

问题就出在反射的缘故。

在尽想着进程保活，先把进程正常的生命给保护好了，你就成功了。

#### ContentProvider

ContentProvider作为Android的四大组件之一，也算是使用频次较高的类。但接下来，我要跟大家简单分享下ContentProvider存在的风险，讲完之后，你或许不再想使用该组件。

ContentProvider作为数据提供者，分为stable与unstable之分，看过一些Android相关的书籍，很少有作者能讲到这一块。对于ContentProvider之坑，那更甚至无人谈及，下面我就


#### classloader

####
push管控，自家的个推一定是全程绿灯，至于第3方那就不一定了。

### 其他

魔高一尺道高一丈，从系统层面来说99.9%的行为都是可控的，剩下的0.1%那是指android漏洞，除非linux漏洞之类的提权来改变情况，否则要进程保活，绝无生还之路。

不是你的莫强求，是你的莫放手

多进程与多线程架构，能解决问题吗？

非用户所需求，明明用户已经退出，却非要在后台偷偷运行，更甚是偷跑用户流量与隐私信息。

我知道很多开发者感到很无奈，进程保活的需求，往往是产品，是老板的要求，是为了一个更好看的数据报表，或者是为了更好的忽悠投资人的钱。不管出于什么理由，我想说对你们说，如果此刻你手上的手机，后台时刻运行几十个app，你能接受吗？


我曾经干过手机底层的性能优化，功耗优化工作，深知不少app的流氓行径。更深见过，为了存活后台有进程不断死循环得执行任务。

最后，想告诫广大的App开发工程师，app进程存活之路不可取。为了android有更好的用户体验，为了不影响手机系统性能，为了不降低手机续航能力，更为了自己的饭碗，请共同维护Android的良好生态。如果每一个App都想方设法地去保活，如果手机厂商不设法拦截App的流氓行为，只会让更多的用户反感Android，最后都转向IOS。 假如有一天所有App保活真的都成功了，那么自己的饭碗可能给“保活”不了，你也就该转IOS，或者另一个全新的系统。  留存率、在线活跃时间等指标

再或者说“show me the code, change the world”的霸气。
